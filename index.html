<!DOCTYPE html>
<html lang="pt-pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Torre de Palitos 3D (Efeitos Atualizados)</title>
    
    <!-- Estilos B√°sicos -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <style>
        body, html { 
            margin: 0; padding: 0; overflow: hidden; 
            background-color: #050505; 
            font-family: sans-serif; color: white; 
            height: 100%;
            transition: background 0.5s ease;
        }
        
        #canvas-container { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 1; }
        
        #ui-layer {
            position: fixed; bottom: 0; left: 0; width: 100%;
            display: flex; flex-direction: column; align-items: center;
            z-index: 10; pointer-events: none;
            transition: transform 0.4s cubic-bezier(0.25, 1, 0.5, 1);
        }
        
        .interactive-area { 
            pointer-events: auto; background: rgba(20,20,20,0.9); padding: 20px; padding-top: 10px; 
            border-top-left-radius: 20px; border-top-right-radius: 20px; border: 1px solid #333; border-bottom: none;
            backdrop-filter: blur(10px); box-shadow: 0 -5px 20px rgba(0, 0, 0, 0.5);
            display: flex; flex-direction: column; align-items: center; min-width: 280px;
            max-height: 80vh; overflow-y: auto; /* Scroll para muitos bot√µes */
            scrollbar-width: none; 
            -ms-overflow-style: none;
        }
        .interactive-area::-webkit-scrollbar { display: none; }
        
        #toggle-btn { width: 100%; height: 30px; display: flex; justify-content: center; align-items: center; cursor: pointer; color: #fbbf24; margin-bottom: 5px; }
        #ui-layer.hidden-ui { transform: translateY(calc(100% - 40px)); }
        #arrow-icon { transition: transform 0.4s ease; }
        #ui-layer.hidden-ui #arrow-icon { transform: rotate(180deg); }
        
        h1 { color: #fbbf24; margin: 0 0 15px 0; font-size: 1.2rem; text-align: center; text-transform: uppercase; letter-spacing: 2px; font-weight: bold; }
        #status-msg { color: #888; font-size: 0.75rem; text-align: center; margin-top: 10px; font-family: monospace; }
        
        /* Grelha de Efeitos Expandida */
        .effects-grid {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 8px;
            width: 100%;
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #333;
        }

        .effect-btn {
            background: #333;
            border: none;
            border-radius: 8px;
            color: #ddd;
            font-size: 0.7rem;
            padding: 10px 4px;
            cursor: pointer;
            transition: all 0.2s;
            text-transform: uppercase;
            font-weight: bold;
            display: flex; justify-content: center; align-items: center;
        }

        .effect-btn:active { transform: scale(0.95); }
        .effect-btn.active { background: #fbbf24; color: #000; box-shadow: 0 0 10px #fbbf24; }

        #loader { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #000; z-index: 9999; display: flex; flex-direction: column; justify-content: center; align-items: center; }
        .spinner { border: 4px solid #333; border-top: 4px solid #fbbf24; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin-bottom: 20px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        #error-log { color: #ff4444; background: rgba(50,0,0,0.9); padding: 20px; border-radius: 8px; max-width: 90%; font-family: monospace; display: none; margin-top: 20px; }
    </style>

    <!-- Bibliotecas -->
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/build/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"></script>
    <script src="https://unpkg.com/@jaames/iro@5.5.2/dist/iro.min.js"></script>
</head>
<body>
    <div id="loader">
        <div class="spinner"></div>
        <div id="loading-text">A carregar motor 3D...</div>
        <div id="error-log"></div>
    </div>
    
    <div id="canvas-container"></div>
    
    <div id="ui-layer">
        <div class="interactive-area">
            <div id="toggle-btn" onclick="toggleUI()">
                <svg id="arrow-icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 12 15 18 9"></polyline></svg>
            </div>
            <h1>Torre Eiffel</h1>
            <div id="color-picker"></div>
            
            <!-- Bot√µes de Efeitos -->
            <div class="effects-grid">
                <!-- B√°sicos -->
                <button class="effect-btn active" onclick="setEffect('solid')" id="btn-solid">Fixa</button>
                <button class="effect-btn" onclick="setEffect('rainbow')" id="btn-rainbow">üåà Rainbow</button>
                <button class="effect-btn" onclick="setEffect('fire')" id="btn-fire">üî• Fogo</button>
                
                <!-- Ritmo -->
                <button class="effect-btn" onclick="setEffect('heartbeat')" id="btn-heartbeat">‚ù§ Heart</button>
                <button class="effect-btn" onclick="setEffect('pisca')" id="btn-pisca">‚ú® Pisca</button>
                <button class="effect-btn" onclick="setEffect('disco')" id="btn-disco">üéâ Disco</button>
                
                <!-- Ambiente -->
                <button class="effect-btn" onclick="setEffect('fade')" id="btn-fade">üåä Fade</button>
                <button class="effect-btn" onclick="setEffect('thunder')" id="btn-thunder">‚ö° Trov√£o</button>
                <button class="effect-btn" onclick="setEffect('sos')" id="btn-sos">üÜò SOS</button>

                <!-- Bandeiras e Temas -->
                <button class="effect-btn" onclick="setEffect('france')" id="btn-france">üá´üá∑ Fran√ßa</button>
                <button class="effect-btn" onclick="setEffect('brazil')" id="btn-brazil">üáßüá∑ Brasil</button>
                <button class="effect-btn" onclick="setEffect('aurora')" id="btn-aurora">üåå Aurora</button>
                
                <button class="effect-btn" onclick="setEffect('xmas')" id="btn-xmas">üéÑ Natal</button>
                <button class="effect-btn" onclick="setEffect('halloween')" id="btn-halloween">üéÉ Hallow</button>
                <button class="effect-btn" onclick="setEffect('sunset')" id="btn-sunset">üåÖ Sunset</button>
                
                <button class="effect-btn" onclick="setEffect('police')" id="btn-police">üö® Pol√≠cia</button>
                <button class="effect-btn" onclick="setEffect('ice')" id="btn-ice">‚ùÑ Gelo</button>
                <button class="effect-btn" onclick="setEffect('candy')" id="btn-candy">üç¨ Candy</button>
            </div>

            <div id="status-msg">Estado: Cor Fixa</div>
        </div>
    </div>

    <script>
        function toggleUI() { document.getElementById('ui-layer').classList.toggle('hidden-ui'); }
        function showError(msg) {
            const loader = document.getElementById('loader'); const errorLog = document.getElementById('error-log'); const spinner = document.querySelector('.spinner');
            loader.style.display = 'flex'; if(spinner) spinner.style.display = 'none'; errorLog.style.display = 'block'; errorLog.innerHTML += "<strong>ERRO:</strong> " + msg + "<br>";
        }
        window.onerror = function(message) { showError(message); };

        let scene, camera, renderer, controls, towerMaterial, pointLight;
        let currentEffect = 'solid'; 
        let baseColor = new THREE.Color("#ffaa00"); 
        let lastDiscoChange = 0; 

        function updateBackground(hexColor) {
            document.body.style.background = `radial-gradient(circle at center, ${hexColor}33 0%, #050505 100%)`;
        }

        // Fun√ß√£o para ativar efeitos
        function setEffect(effectName) {
            currentEffect = effectName;
            
            // UI
            document.querySelectorAll('.effect-btn').forEach(btn => btn.classList.remove('active'));
            document.getElementById('btn-' + effectName).classList.add('active');
            
            // Texto
            const labels = {
                'solid': 'Cor Fixa', 'rainbow': 'Arco-√çris', 'fire': 'Fogueira',
                'heartbeat': 'Batimento', 'pisca': 'Estrobosc√≥pio', 'disco': 'Modo Festa',
                'fade': 'Respira√ß√£o', 'police': 'Pol√≠cia', 'xmas': 'Natal',
                'thunder': 'Tempestade', 'sos': 'Sinal SOS', 'france': 'Vive la France',
                'brazil': 'Brasil', 'halloween': 'Dia das Bruxas', 'ice': 'Reino do Gelo', 'candy': 'Doce',
                'aurora': 'Aurora Boreal', 'sunset': 'P√¥r do Sol Quente'
            };
            document.getElementById('status-msg').innerText = "Modo: " + labels[effectName];
            
            // Reset se voltar para s√≥lido
            if(effectName === 'solid') {
                applyColor(baseColor, 0.9, 2);
            }
        }
        
        function applyColor(color, opacity, intensity) {
            towerMaterial.color.copy(color);
            towerMaterial.opacity = opacity;
            pointLight.color.copy(color);
            pointLight.intensity = intensity;
            updateBackground("#" + color.getHexString());
        }

        function init() {
            try {
                if (typeof THREE === 'undefined') throw new Error("Three.js falhou.");
                if (typeof iro === 'undefined') throw new Error("iro.js falhou.");
                const container = document.getElementById('canvas-container');
                
                scene = new THREE.Scene(); 
                scene.fog = new THREE.FogExp2(0x050505, 0.02);
                
                camera = new THREE.PerspectiveCamera(60, window.innerWidth / window.innerHeight, 0.1, 1000);
                camera.position.set(0, 18, 50); 
                
                renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
                renderer.setSize(window.innerWidth, window.innerHeight); renderer.setPixelRatio(window.devicePixelRatio);
                container.appendChild(renderer.domElement);
                
                scene.add(new THREE.AmbientLight(0xffffff, 0.4));
                pointLight = new THREE.PointLight(0xffaa00, 2, 60); pointLight.position.set(0, 15, 0); scene.add(pointLight);
                
                towerMaterial = new THREE.LineBasicMaterial({ color: 0xffaa00, linewidth: 1, transparent: true, opacity: 0.9, blending: THREE.AdditiveBlending });
                
                createCustomTower();
                
                controls = new THREE.OrbitControls(camera, renderer.domElement);
                controls.enableDamping = true; controls.dampingFactor = 0.05; controls.autoRotate = true; controls.autoRotateSpeed = 2.0; controls.target.set(0, 15, 0);
                
                const colorPicker = new iro.ColorPicker('#color-picker', { width: 220, color: "#ffaa00", borderWidth: 2, borderColor: "#fff", layout: [{ component: iro.ui.Wheel }, { component: iro.ui.Slider, options: { sliderType: 'value' } }] });
                
                updateBackground("#ffaa00");

                colorPicker.on('color:change', (color) => {
                    baseColor.set(color.hexString); 
                    if (currentEffect === 'solid') {
                        applyColor(baseColor, 0.9, 2);
                    }
                });
                
                document.getElementById('loader').style.display = 'none';
                animate(); window.addEventListener('resize', onResize);
            } catch (err) { showError(err.message); }
        }

        function createCustomTower() {
            const towerGroup = new THREE.Group();
            const vertices = [], indices = [];
            let idxCounter = 0;
            const addV = (x, y, z) => { vertices.push(x, y, z); return idxCounter++; };
            const addSquareLevel = (w, h) => {
                const half = w / 2;
                return [addV(-half, h, half), addV(half, h, half), addV(half, h, -half), addV(-half, h, -half)];
            };
            const connectLevels = (bot, top, cross=true) => {
                for(let i=0; i<4; i++) { indices.push(bot[i], top[i]); indices.push(bot[i], bot[(i+1)%4]); }
                if(cross) { for(let i=0; i<4; i++) indices.push(bot[i], top[(i+1)%4], bot[(i+1)%4], top[i]); }
            };
            const addArch = (idxA, idxB) => {
                const x1 = vertices[idxA*3], y1 = vertices[idxA*3+1], z1 = vertices[idxA*3+2];
                const x2 = vertices[idxB*3], y2 = vertices[idxB*3+1], z2 = vertices[idxB*3+2];
                const segments = 8; const archH = 5.0; let prev = idxA;
                for(let i=1; i<segments; i++) {
                    let t = i/segments;
                    let x = x1 + (x2-x1)*t; let z = z1 + (z2-z1)*t; let yBase = y1 + (y2-y1)*t; let yCurve = archH * 4 * t * (1-t);
                    let curr = addV(x, yBase + yCurve, z); indices.push(prev, curr); prev = curr;
                }
                indices.push(prev, idxB);
            };

            const yFloor = 0; const wBase = 18; 
            const yPlat1 = 13; const wPlat1 = 7;
            const yPlat2 = 25; const wPlat2 = 3;
            const yTip = 42; const wTip = 1.5; 

            let baseLevel = addSquareLevel(wBase, yFloor);
            addArch(baseLevel[0], baseLevel[1]); addArch(baseLevel[1], baseLevel[2]);
            addArch(baseLevel[2], baseLevel[3]); addArch(baseLevel[3], baseLevel[0]);
            let prev = baseLevel; let segs1 = 4;
            for(let i=1; i<=segs1; i++) {
                let t = i/segs1; let curW = wBase + (wPlat1 - wBase) * t; let curY = yFloor + (yPlat1 - yFloor) * t;
                let next = addSquareLevel(curW, curY); connectLevels(prev, next, true); prev = next;
            }
            let rail1 = addSquareLevel(wPlat1 + 1.2, yPlat1 + 1.2); connectLevels(prev, rail1, false); prev = addSquareLevel(wPlat1, yPlat1); 
            let segs2 = 4;
            for(let i=1; i<=segs2; i++) {
                let t = i/segs2; let curW = wPlat1 + (wPlat2 - wPlat1) * t; let curY = yPlat1 + (yPlat2 - yPlat1) * t;
                let next = addSquareLevel(curW, curY); connectLevels(prev, next, true); prev = next;
            }
            let rail2 = addSquareLevel(wPlat2 + 0.8, yPlat2 + 1.0); connectLevels(prev, rail2, false); prev = addSquareLevel(wPlat2, yPlat2);
            let segs3 = 6;
            for(let i=1; i<=segs3; i++) {
                let t = i/segs3; let curW = wPlat2 + (wTip - wPlat2) * t; let curY = yPlat2 + (yTip - yPlat2) * t;
                let next = addSquareLevel(curW, curY); connectLevels(prev, next, true); prev = next;
            }
            
            for(let i=0; i<4; i++) indices.push(prev[i], prev[(i+1)%4]);

            const cubeSize = wTip + 0.5; 
            const cubeH = 2.5;
            let cubeBottom = prev;
            let cubeTop = addSquareLevel(cubeSize, yTip + cubeH);
            connectLevels(cubeBottom, cubeTop, false);
            for(let i=0; i<4; i++) indices.push(cubeTop[i], cubeTop[(i+1)%4]);

            const poleHeight = 6.0;
            let centerTop = addV(0, yTip + cubeH, 0);
            cubeTop.forEach(idx => indices.push(idx, centerTop));
            let antennaTip = addV(0, yTip + cubeH + poleHeight, 0);
            indices.push(centerTop, antennaTip);

            const geometry = new THREE.BufferGeometry();
            geometry.setIndex(indices);
            geometry.setAttribute('position', new THREE.Float32BufferAttribute(vertices, 3));
            geometry.computeBoundingBox();
            geometry.translate(0, -5, 0); 

            const mesh = new THREE.LineSegments(geometry, towerMaterial);
            towerGroup.add(mesh);
            scene.add(towerGroup);
        }

        function onResize() {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        }

        // --- LOOP DE ANIMA√á√ÉO COM NOVOS EFEITOS ---
        function animate() {
            requestAnimationFrame(animate);
            if(controls) controls.update();
            
            const now = Date.now();

            if (currentEffect === 'rainbow') {
                const hue = (now % 4000) / 4000; 
                applyColor(new THREE.Color().setHSL(hue, 1, 0.5), 0.9, 2);
            
            } else if (currentEffect === 'fire') {
                const flicker = Math.random() * 0.1; 
                const intensity = 1 + Math.random();
                applyColor(new THREE.Color().setHSL(flicker, 1, 0.5), 0.8 + Math.random()*0.2, intensity);

            } else if (currentEffect === 'heartbeat') {
                const beat = (now % 1200) / 1200;
                let pulse = 0;
                if(beat < 0.2) pulse = Math.sin(beat * Math.PI * 5); 
                else if(beat > 0.3 && beat < 0.5) pulse = Math.sin((beat-0.3) * Math.PI * 5) * 0.6; 
                applyColor(baseColor, 0.3 + pulse * 0.7, 0.5 + pulse * 2.5);
            
            } else if (currentEffect === 'pisca') {
                const isOn = Math.floor(now / 250) % 2 === 0;
                applyColor(baseColor, isOn ? 1 : 0.1, isOn ? 3 : 0);
            
            } else if (currentEffect === 'disco') {
                if (now - lastDiscoChange > 200) {
                    const randomColor = new THREE.Color().setHSL(Math.random(), 1, 0.5);
                    applyColor(randomColor, 1, 2);
                    lastDiscoChange = now;
                }

            } else if (currentEffect === 'fade') {
                const fade = (Math.sin(now * 0.002) + 1) / 2;
                applyColor(baseColor, 0.2 + fade * 0.8, fade * 3);
                
            } else if (currentEffect === 'police') {
                const isRed = Math.floor(now / 400) % 2 === 0;
                const color = isRed ? new THREE.Color(1, 0, 0) : new THREE.Color(0, 0, 1);
                applyColor(color, 1, 2);

            } else if (currentEffect === 'xmas') {
                const isRed = Math.floor(now / 1000) % 2 === 0;
                const color = isRed ? new THREE.Color(1, 0, 0) : new THREE.Color(0, 1, 0);
                applyColor(color, 0.9, 2);

            } else if (currentEffect === 'thunder') {
                if (Math.random() > 0.96) {
                    applyColor(new THREE.Color(1, 1, 1), 1, 5); 
                } else {
                    applyColor(new THREE.Color(0.1, 0.1, 0.3), 0.2, 0); 
                }

            } else if (currentEffect === 'sos') {
                const cycle = now % 6000; 
                let isOn = false;
                if (cycle < 1500) isOn = Math.floor(cycle / 250) % 2 === 0; // S
                else if (cycle > 2000 && cycle < 4250) isOn = Math.floor((cycle-2000) / 750) % 2 === 0; // O
                else if (cycle > 4750) isOn = Math.floor((cycle-4750) / 250) % 2 === 0; // S
                applyColor(new THREE.Color(1, 0, 0), isOn ? 1 : 0.1, isOn ? 3 : 0);

            // --- EFEITOS TEM√ÅTICOS ---
            
            } else if (currentEffect === 'france') {
                const t = (now % 3000) / 3000;
                let color = new THREE.Color();
                if (t < 0.33) {
                    const alpha = t / 0.33;
                    color.lerpColors(new THREE.Color(0x0055A4), new THREE.Color(0xFFFFFF), alpha);
                } else if (t < 0.66) {
                    const alpha = (t - 0.33) / 0.33;
                    color.lerpColors(new THREE.Color(0xFFFFFF), new THREE.Color(0xEF4135), alpha);
                } else {
                    const alpha = (t - 0.66) / 0.34;
                    color.lerpColors(new THREE.Color(0xEF4135), new THREE.Color(0x0055A4), alpha);
                }
                applyColor(color, 1, 2);

            } else if (currentEffect === 'brazil') {
                const phase = Math.floor((now % 3000) / 1000);
                let color;
                if (phase === 0) color = new THREE.Color(0, 1, 0); 
                else if (phase === 1) color = new THREE.Color(1, 1, 0); 
                else color = new THREE.Color(0, 0, 1); 
                applyColor(color, 1, 2);

            } else if (currentEffect === 'halloween') {
                const isOrange = Math.floor(now / 1000) % 2 === 0;
                const color = isOrange ? new THREE.Color(1, 0.5, 0) : new THREE.Color(0.5, 0, 1);
                applyColor(color, 1, 2);

            } else if (currentEffect === 'ice') {
                const t = (Math.sin(now * 0.002) + 1) / 2;
                const color = new THREE.Color().lerpColors(new THREE.Color(1,1,1), new THREE.Color(0, 1, 1), t);
                applyColor(color, 0.8, 2);

            } else if (currentEffect === 'candy') {
                const hue = (now % 5000) / 5000;
                const color = new THREE.Color().setHSL(hue, 0.8, 0.7);
                applyColor(color, 1, 2);

            } else if (currentEffect === 'aurora') { // Substitui Portugal
                const t = (Math.sin(now * 0.001) + 1) / 2;
                // Transi√ß√£o Verde Aurora -> Roxo Aurora
                const color = new THREE.Color().lerpColors(new THREE.Color(0x00ffaa), new THREE.Color(0xaa00ff), t);
                applyColor(color, 0.8, 2);

            } else if (currentEffect === 'sunset') { // Sunset s√≥ Quente
                const t = (Math.sin(now * 0.001) + 1) / 2;
                // Transi√ß√£o Amarelo Dourado -> Vermelho Profundo
                const color = new THREE.Color().lerpColors(new THREE.Color(0xffcc33), new THREE.Color(0xcc3300), t);
                applyColor(color, 0.9, 2);
            }

            renderer.render(scene, camera);
        }
        
        if (document.readyState === 'loading') document.addEventListener('DOMContentLoaded', init); else init();
    </script>
</body>
</html>